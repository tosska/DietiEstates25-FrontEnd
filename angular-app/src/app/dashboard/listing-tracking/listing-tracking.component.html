<div class="max-w-6xl mx-auto p-6 md:p-8 text-olive-900">

  <app-listing-summary-card [listingId]="listingId"></app-listing-summary-card>

  <div class="mb-8">
    <h1 class="text-3xl font-extrabold text-olive-900 tracking-tight">Tracking Offerte</h1>
    <p class="mt-2 text-lg text-olive-900/60 font-medium">
      Storico delle offerte ricevute per l'annuncio #{{ listingId }}
    </p>

    <div class="mt-6 sm:mt-4 flex-shrink-0">
      <button (click)="openAddOfferModal()" 
              class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-bold rounded-2xl shadow-lg shadow-olive-200 text-white bg-olive-500 hover:bg-olive-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-olive-500 transition-all duration-200 transform active:scale-95">
        <svg class="w-5 h-5 mr-2 -ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Aggiungi Offerta
      </button>
    </div>
  </div>

  @if (offers.length > 0) {
    <div class="bg-white rounded-3xl shadow-xl border border-olive-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-olive-100">
          <thead class="bg-olive-50">
            <tr>
              <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-olive-900 uppercase tracking-wider">
                Offerta
              </th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-olive-900 uppercase tracking-wider">
                Importo
              </th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-olive-900 uppercase tracking-wider">
                Data Invio
              </th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-olive-900 uppercase tracking-wider">
                Data Risposta
              </th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-olive-900 uppercase tracking-wider">
                Stato
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-olive-100">
            
            @for (offer of offers; track offer.id) {
              <tr class="hover:bg-olive-50/50 transition-colors duration-150 group">
                
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center space-x-3">
                    
                    @if (offer.counteroffer) {
                      <div class="p-2 bg-olive-50 rounded-full text-olive-500">
                         <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                         </svg>
                      </div>
                    } @else {
                      <div class="p-2 bg-blue-50 rounded-full text-blue-600">
                         <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                         </svg>
                      </div>
                    }

                    <div>
                      @if(!offer.externalName) {
                        <div class="text-sm font-bold text-olive-900">
                          {{ offer.customer?.name && offer.customer?.surname 
                             ? offer.customer?.name + ' ' + offer.customer?.surname 
                             : (offer.counteroffer ? 'Tua Controfferta' : 'Utente Sconosciuto') }}
                        </div>
                        <div class="text-xs text-olive-900/50 font-medium truncate">
                          email&#64;placeholder.com
                        </div>
                      } @else {
                        <div class="text-sm font-bold text-olive-900">
                          {{ offer.externalName }}
                        </div>
                        <div class="text-xs text-olive-900/50 font-medium truncate">
                            Offerta Esterna
                        </div>
                      }
                    </div>
                  </div>
                </td>
                
                <td class="px-6 py-4 whitespace-nowrap text-sm font-extrabold text-olive-900">
                  {{ offer.amount | currency:'EUR':'symbol':'1.0-0' }}
                </td>
                
                <td class="px-6 py-4 whitespace-nowrap text-sm text-olive-900/70 font-medium">
                  {{ offer.offerDate | date:'dd/MM/yyyy HH:mm' }}
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-sm text-olive-900/70 font-medium">
                  @if (offer.response_Date) {
                    {{ offer.response_Date | date:'dd/MM/yyyy HH:mm' }}
                  } @else {
                    <span class="text-gray-300">-</span>
                  }
                </td>
                
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex items-center px-3 py-1 rounded-xl text-xs font-bold border"
                        [ngClass]="{
                          'bg-olive-100 text-olive-700 border-olive-200': offer.status === 'Accepted',
                          'bg-red-50 text-red-600 border-red-100': offer.status === 'Rejected',
                          'bg-yellow-50 text-yellow-700 border-yellow-100': offer.status === 'Pending'
                        }">
                    {{ offer.status }}
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button (click)="goBack()" 
              class="inline-flex items-center px-6 py-3 border border-olive-200 text-sm font-bold rounded-2xl shadow-sm text-olive-900 bg-white hover:bg-olive-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-olive-500 transition-all">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
        Torna indietro
      </button>
    </div>

  } @else {
    <div class="col-span-full flex flex-col items-center justify-center py-20 px-6 bg-white rounded-3xl shadow-xl border border-olive-100 text-center">
      <div class="w-20 h-20 bg-olive-50 rounded-full flex items-center justify-center mb-6 text-olive-400">
         <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
      </div>
      <h2 class="text-2xl font-bold text-olive-900">Nessuna offerta trovata</h2>
      <p class="mt-2 text-olive-900/60 max-w-sm font-medium">
        Non sono state ancora inviate offerte per questo annuncio.
      </p>
      
      <button (click)="goBack()" 
              class="mt-8 px-8 py-3 bg-olive-500 hover:bg-olive-400 text-white font-bold rounded-2xl shadow-lg shadow-olive-200 transition-all hover:-translate-y-1">
        Torna indietro
      </button>
    </div>
  }

</div>

@if(addOfferModalOpen) {
  <app-add-offer-modal 
    [listingId]="listingId!" 
    (close)="addOfferModalOpen = false" 
    (offerSubmitted)="fetchOfferHistory()">
  </app-add-offer-modal>
}